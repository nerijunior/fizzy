<% cache user_filtering do %>

  <%= tag.aside id: "filter-settings",
        class: class_names("filters flex align-center gap-half justify-center center margin-block-end", { "filters--expanded": user_filtering.expanded? }),
        data: {
          controller: "toggle-class filter-settings",
          toggle_class_toggle_class: "filters--expanded",
          filter_settings_filters_set_class: "filters--has-filters-set",
          filter_settings_refresh_url_value: settings_refresh_path } do %>
    <%= form_with url: cards_path, method: :get, class: "", data: { controller: "form", turbo_frame: "card_columns", filter_settings_target: "form", turbo_action: "advance" } do |form| %>
      <%= hidden_field_tag :expand_all, true, disabled: !user_filtering.expanded?, data: { toggle_enable_target: "element" } %>
      <% user_filtering.filter.collections.each do |collection| %>
        <%= filter_hidden_field_tag "collection_ids[]", collection.id %>
      <% end %>

      <div class="flex-inline center align-center gap-half" data-controller="toggle-enable">
        <%= render "filters/settings/terms", filter: user_filtering.filter, form: form %>
        <%= render "filters/settings/controls", user_filtering: user_filtering, form: form %>

        <%= render "filters/settings/toggle", user_filtering: user_filtering %>
      </div>
    <% end %>
    <%= render "filters/settings/manage", user_filtering: user_filtering %>
  <% end %>

<% end %>
